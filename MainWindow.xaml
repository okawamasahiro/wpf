<Window x:Class="wpf.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:wpf"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:avalonedit="http://icsharpcode.net/sharpdevelop/avalonedit"
        Title="GPTサンプル"
        Height="700" Width="1000"
        Background="{DynamicResource MaterialDesignPaper}"
        TextElement.Foreground="{DynamicResource MaterialDesignBody}"
        FontFamily="Segoe UI">

    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <!-- ✅ これが最重要（テーマ本体を読み込む） -->
                <materialDesign:BundledTheme BaseTheme="Dark"
                                             PrimaryColor="Green"
                                             SecondaryColor="Lime" />

                <!-- ✅ 各種スタイル定義を含むデフォルト -->
                <!--<ResourceDictionary Source="pack://application:,,,/MaterialDesignThemes.Wpf;component/Themes/MaterialDesignTheme.Defaults.xaml" />-->
                <ResourceDictionary Source="pack://application:,,,/MaterialDesignThemes.Wpf;component/Themes/MaterialDesign3.Defaults.xaml" />

                <!-- ✅ テキストボックス・ボタンなどの個別テーマ -->
                <ResourceDictionary Source="pack://application:,,,/MaterialDesignThemes.Wpf;component/Themes/MaterialDesignTheme.TextBox.xaml" />
                <ResourceDictionary Source="pack://application:,,,/MaterialDesignThemes.Wpf;component/Themes/MaterialDesignTheme.Button.xaml" />
            </ResourceDictionary.MergedDictionaries>

            <local:SyntaxConverter x:Key="SyntaxConverter"/>

            <!-- 💬 通常テキスト用 -->
            <DataTemplate x:Key="ChatTextTemplate" DataType="{x:Type local:ChatMessageModel}">
                <materialDesign:Card Margin="8" Padding="12" Background="#2C2C2C">
                    <TextBlock Text="{Binding Text}" 
                               TextWrapping="Wrap"
                               FontSize="14"
                               Foreground="{DynamicResource MaterialDesignBody}" />
                </materialDesign:Card>
            </DataTemplate>

            <!-- 🧩 コードブロック -->
            <DataTemplate x:Key="ChatCodeTemplate" DataType="{x:Type local:ChatMessageModel}">
                <materialDesign:Card Margin="8" Padding="0" Background="#1E1E1E">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <!-- 上部バー -->
                        <DockPanel Grid.Row="0" LastChildFill="False" Margin="4,4,4,0">
                            <TextBlock Text="{Binding Language}" 
                                       Foreground="LightGray"
                                       FontSize="12"
                                       DockPanel.Dock="Left"
                                       VerticalAlignment="Center"/>
                            <Button Content="📋 コピー"
                                    DockPanel.Dock="Right"
                                    Click="CopyCode_Click"
                                    Style="{StaticResource MaterialDesignFlatButton}"
                                    Foreground="LightGray"
                                    FontSize="12"
                                    Padding="4,0"
                                    ToolTip="コピー"/>
                        </DockPanel>

                        <!-- コード本文 -->
                        <avalonedit:TextEditor Grid.Row="1"
                                               x:Name="CodeEditor"
                                               SyntaxHighlighting="{Binding Language, Converter={StaticResource SyntaxConverter}}"
                                               IsReadOnly="True"
                                               FontFamily="Consolas"
                                               FontSize="13"
                                               Foreground="White"
                                               Background="Transparent"
                                               HorizontalScrollBarVisibility="Auto"
                                               VerticalScrollBarVisibility="Hidden"
                                               Loaded="CodeEditor_Loaded"/>
                    </Grid>
                </materialDesign:Card>
            </DataTemplate>

            <!-- 🖼 画像テンプレート -->
            <DataTemplate x:Key="ChatImageTemplate" DataType="{x:Type local:ChatMessageModel}">
                <materialDesign:Card Margin="8" Padding="8" Background="#2C2C2C">
                    <Image Source="{Binding Image}"
                           MaxWidth="512"
                           Stretch="Uniform"
                           Cursor="Hand"
                           MouseLeftButtonUp="Image_Click"/>
                </materialDesign:Card>
            </DataTemplate>

            <!-- セレクタ -->
            <local:ChatTemplateSelector x:Key="ChatSelector"
                                        TextTemplate="{StaticResource ChatTextTemplate}"
                                        CodeTemplate="{StaticResource ChatCodeTemplate}"
                                        ImageTemplate="{StaticResource ChatImageTemplate}"/>
        </ResourceDictionary>
    </Window.Resources>

    <!-- 🧱 レイアウト -->
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- チャットエリア -->
        <ScrollViewer x:Name="ChatScroll"
                      Grid.Row="0"
                      VerticalScrollBarVisibility="Auto"
                      Background="{DynamicResource MaterialDesignPaper}">
            <ItemsControl x:Name="ChatList"
                          ItemTemplateSelector="{StaticResource ChatSelector}"/>
        </ScrollViewer>

        <!-- 入力欄 -->
        <DockPanel Grid.Row="1" Margin="0,10,0,0">
            <TextBox x:Name="InputTextBox"
                     Width="880"
                     Height="80"
                     FontSize="14"
                     Style="{StaticResource MaterialDesignOutlinedTextBox}"
                     materialDesign:HintAssist.Hint="メッセージを入力..."
                     AcceptsReturn="True"
                     TextWrapping="Wrap"
                     AcceptsTab="True"
                     VerticalScrollBarVisibility="Auto"
                     VerticalContentAlignment="Top"
                     KeyDown="InputTextBox_KeyDown"/>

            <Button Content="送信"
                Width="90"
                Height="40"
                Style="{DynamicResource MaterialDesignButton}"
                Click="SendButton_Click"
                DockPanel.Dock="Right"/>
        </DockPanel>
    </Grid>
</Window>
