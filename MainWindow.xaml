<Window x:Class="wpf.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:wpf"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:avalonedit="http://icsharpcode.net/sharpdevelop/avalonedit"
        Title="GPTサンプル"
        Height="700" Width="1000"
        Background="{DynamicResource MaterialDesignPaper}"
        TextElement.Foreground="{DynamicResource MaterialDesignBody}"
        FontFamily="Segoe UI">

    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <!-- ✅ これが最重要（テーマ本体を読み込む） -->
                <materialDesign:BundledTheme BaseTheme="Dark"
                                             PrimaryColor="Green"
                                             SecondaryColor="Lime" />

                <!-- ✅ 各種スタイル定義を含むデフォルト -->
                <!--<ResourceDictionary Source="pack://application:,,,/MaterialDesignThemes.Wpf;component/Themes/MaterialDesignTheme.Defaults.xaml" />-->
                <ResourceDictionary Source="pack://application:,,,/MaterialDesignThemes.Wpf;component/Themes/MaterialDesign3.Defaults.xaml" />

                <!-- ✅ テキストボックス・ボタンなどの個別テーマ -->
                <ResourceDictionary Source="pack://application:,,,/MaterialDesignThemes.Wpf;component/Themes/MaterialDesignTheme.TextBox.xaml" />
                <ResourceDictionary Source="pack://application:,,,/MaterialDesignThemes.Wpf;component/Themes/MaterialDesignTheme.Button.xaml" />
            </ResourceDictionary.MergedDictionaries>

            <local:SyntaxConverter x:Key="SyntaxConverter"/>

            <!-- テキスト用 -->
            <DataTemplate x:Key="BaseChatTextTemplate" DataType="{x:Type local:ChatMessageModel}">
                <Grid Margin="4">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <!-- ContentPresenter を真ん中の列に置いて、
                    左右どちらの列を埋めるかで寄せを変える -->
                    <ContentPresenter x:Name="Bubble"
                          Grid.Column="1" />
                </Grid>
            </DataTemplate>

            <!-- アシスタントメッセージ（左寄せ） -->
            <DataTemplate x:Key="AssistantTextTemplate" DataType="{x:Type local:ChatMessageModel}">
                <Grid Margin="4">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <materialDesign:Card Grid.Column="0"
                             Margin="8"
                             Padding="12"
                             Background="#2C2C2C">
                        <TextBlock Text="{Binding Text}"
                       TextWrapping="Wrap"
                       FontSize="14"
                       Foreground="{DynamicResource MaterialDesignBody}" />
                    </materialDesign:Card>
                </Grid>
            </DataTemplate>

            <!-- ユーザーメッセージ（右寄せ） -->
            <DataTemplate x:Key="UserTextTemplate" DataType="{x:Type local:ChatMessageModel}">
                <Grid Margin="4">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <materialDesign:Card Grid.Column="1"
                             Margin="8"
                             Padding="12"
                             Background="{DynamicResource PrimaryHueMidBrush}">
                        <TextBlock Text="{Binding Text}"
                       TextWrapping="Wrap"
                       FontSize="14"
                       Foreground="White" />
                    </materialDesign:Card>
                </Grid>
            </DataTemplate>
            
            <!-- 🧩 コードブロック -->
            <DataTemplate x:Key="ChatCodeTemplate" DataType="{x:Type local:ChatMessageModel}">
                <materialDesign:Card Margin="8" Padding="0" Background="#1E1E1E">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <!-- 上部バー -->
                        <DockPanel Grid.Row="0" LastChildFill="False" Margin="4,4,4,0">
                            <TextBlock Text="{Binding Language}" 
                                       Foreground="LightGray"
                                       FontSize="12"
                                       DockPanel.Dock="Left"
                                       VerticalAlignment="Center"/>
                            <Button Content="📋 コピー"
                                    DockPanel.Dock="Right"
                                    Click="CopyCode_Click"
                                    Style="{StaticResource MaterialDesignFlatButton}"
                                    Foreground="LightGray"
                                    FontSize="12"
                                    Padding="4,0"
                                    ToolTip="コピー"/>
                        </DockPanel>

                        <!-- コード本文 -->
                        <avalonedit:TextEditor Grid.Row="1"
                                               x:Name="CodeEditor"
                                               SyntaxHighlighting="{Binding Language, Converter={StaticResource SyntaxConverter}}"
                                               IsReadOnly="True"
                                               FontFamily="Consolas"
                                               FontSize="13"
                                               Foreground="White"
                                               Background="Transparent"
                                               HorizontalScrollBarVisibility="Auto"
                                               VerticalScrollBarVisibility="Hidden"
                                               Loaded="CodeEditor_Loaded"/>
                    </Grid>
                </materialDesign:Card>
            </DataTemplate>

            <!-- 🖼 画像テンプレート -->
            <DataTemplate x:Key="ChatImageTemplate" DataType="{x:Type local:ChatMessageModel}">
                <materialDesign:Card Margin="8" Padding="8" Background="#2C2C2C">
                    <Image Source="{Binding Image}"
                           MaxWidth="512"
                           Stretch="Uniform"
                           Cursor="Hand"
                           MouseLeftButtonUp="Image_Click"/>
                </materialDesign:Card>
            </DataTemplate>

            <!-- セレクタ -->
            <local:ChatTemplateSelector x:Key="ChatSelector"
                                        TextTemplate="{StaticResource BaseChatTextTemplate}"
                                        CodeTemplate="{StaticResource ChatCodeTemplate}"
                                        ImageTemplate="{StaticResource ChatImageTemplate}"
                                        UserTextTemplate="{StaticResource UserTextTemplate}"
                                        AssistantTextTemplate="{StaticResource AssistantTextTemplate}" />

        </ResourceDictionary>
    </Window.Resources>

    <!-- 🧱 レイアウト -->
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- チャットエリア -->
        <ScrollViewer x:Name="ChatScroll"
                      Grid.Row="0"
                      VerticalScrollBarVisibility="Auto"
                      Background="{DynamicResource MaterialDesignPaper}">
            <ItemsControl x:Name="ChatList"
                          ItemTemplateSelector="{StaticResource ChatSelector}"/>
        </ScrollViewer>

        <!-- 入力欄 -->
        <DockPanel Grid.Row="1" Margin="0,10,0,0">
            <Border 
                Background="#2C2C2C" 
                CornerRadius="8"
                Padding="4"
                BorderBrush="#3A3A3A"
                BorderThickness="1"
                DockPanel.Dock="Left"
                Width="970"
                MaxHeight="300"
                Height="Auto">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!-- 入力ボックス -->
                    <TextBox x:Name="InputTextBox"
                     Grid.Column="0"
                     FontSize="14"
                     Margin="6,0,10,0"
                     Style="{StaticResource MaterialDesignOutlinedTextBox}"
                     Background="Transparent"
                     Foreground="#EAEAEA"
                     BorderThickness="0"
                     AcceptsReturn="True"
                     TextWrapping="Wrap"
                     VerticalScrollBarVisibility="Auto"
                     VerticalContentAlignment="Center"
                     materialDesign:HintAssist.Hint="メッセージを入力..."
                     KeyDown="InputTextBox_KeyDown"/>

                    <!-- 送信ボタン -->
                    <Button x:Name="SendButton"
                        Grid.Column="1"
                        Content="➤"
                        Width="45"
                        Height="45"
                        Style="{DynamicResource MaterialDesignButton}"
                        Background="{DynamicResource PrimaryHueMidBrush}"
                        Foreground="White"
                        FontSize="16"
                        FontWeight="Bold"
                        Margin="0,0,4,0"
                        Click="SendButton_Click"
                        ToolTip="送信"/>
                </Grid>
            </Border>
        </DockPanel>
    </Grid>
</Window>
